<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cart.css') }}">
</head>
<body>
    <div class="cart-container">
        <div class="cart-header">
            <h2>Shopping Cart</h2>
            <form method="post" action="{{ url_for('cart') }}">
                <input type="text" name="product_name" placeholder="Product Name" required>
                <input type="number" name="product_price" placeholder="Product Price" required>
                <button type="submit">Add to Cart</button>
            </form>
            
        </div>
        <div class="cart-body">
            <div class="cart-items">
                {% for item in cart %}
                <div class="cart-item">
                    <div class="item-details">
                        <h3 class="item-name">{{ item.name }}</h3>
                        <div class="item-quantity">
                            <button class="decrement-btn" data-item-index="{{ loop.index0 }}">-</button>
                            <input type="number" value="{{ item.quantity }}" min="1" data-item-index="{{ loop.index0 }}">
                            <button class="increment-btn" data-item-index="{{ loop.index0 }}">+</button>
                        </div>
                        <p class="item-price">Ksh {{ item.price }}</p>
                        <button class="remove-btn" data-item-index="{{ loop.index0 }}">Remove</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="cart-total">
                <div class="total-details">
                        <p>Subtotal: <span>Ksh {{ total }}</span></p>
                    <p>Tax: <span>Ksh {{ tax }}</span></p>
                    <p>Shipping: <span>Ksh {{ shipping }}</span></p>
                </div>
                <div class="total-amount">
                    <p>Total:</p>
                    <h2>Ksh {{ total + tax + shipping }}</h2>
                </div>
            </div>
        </div>
        <button class="checkout-btn">Checkout</button>
    </div>

    <script>
        const decrementButtons = document.querySelectorAll('.decrement-btn');
        const incrementButtons = document.querySelectorAll('.increment-btn');
        const removeButtons = document.querySelectorAll('.remove-btn');

        decrementButtons.forEach((button, index) => {
            button.addEventListener('click', () => updateQuantity(index, -1));
        });

        incrementButtons.forEach((button, index) => {
            button.addEventListener('click', () => updateQuantity(index, 1));
        });

        removeButtons.forEach((button, index) => {
            button.addEventListener('click', () => removeItem(index));
        });

        function updateQuantity(itemIndex, change) {
            const quantityInput = document.querySelectorAll('input[type=number]')[itemIndex];
            let newQuantity = parseInt(quantityInput.value) + change;
            newQuantity = Math.max(1, newQuantity);  // Ensure quantity is at least 1

            quantityInput.value = newQuantity;

            // Send an AJAX request to update the cart on the server
            const formData = new FormData();
            formData.append('update_quantity', 'true');
            formData.append('item_index', itemIndex);
            formData.append('new_quantity', newQuantity);

            fetch("{{ url_for('cart') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Updated quantity for item ${itemIndex} to ${newQuantity}`);
                } else {
                    console.error('Failed to update quantity');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        function removeItem(itemIndex) {
            // Send an AJAX request to remove the item from the cart on the server
            const formData = new FormData();
            formData.append('remove_item', 'true');
            formData.append('item_index', itemIndex);

            fetch("{{ url_for('cart') }}", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log(`Removed item ${itemIndex} from the cart`);
                    // Optionally, you can remove the item from the page
                } else {
                    console.error('Failed to remove item');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>